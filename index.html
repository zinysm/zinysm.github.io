<!DOCTYPE html>
<html lang="lt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Renovacijos Master Planas - Ker≈≥ Kerai</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a2e;
            color: #eee;
            padding: 20px;
            min-height: 100vh;
        }
        
        h1 { text-align: center; margin-bottom: 5px; color: #fff; font-size: 24px; }
        .subtitle { text-align: center; color: #888; margin-bottom: 20px; font-size: 14px; }
        
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; justify-content: center; }
        .tab {
            padding: 10px 25px; background: #252545; border: none; color: #aaa;
            cursor: pointer; border-radius: 8px; font-size: 14px; transition: all 0.2s;
        }
        .tab:hover { background: #353565; }
        .tab.active { background: #667eea; color: #fff; }
        
        .view { display: none; }
        .view.active { display: block; }
        
        .btn { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; transition: all 0.2s; }
        .btn-primary { background: #667eea; color: #fff; }
        .btn-primary:hover { background: #5a6fd6; }
        .btn-success { background: #27ae60; color: #fff; }
        .btn-success:hover { background: #219a52; }
        .btn-danger { background: #e74c3c; color: #fff; }
        .btn-danger:hover { background: #c0392b; }
        .btn-secondary { background: #555; color: #fff; }
        .btn-secondary:hover { background: #666; }
        .btn-small { padding: 4px 8px; font-size: 11px; }
        
        .editor-container { max-width: 1400px; margin: 0 auto; }
        .toolbar { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; align-items: center; }
        .start-date-input {
            padding: 8px 12px; border: 1px solid #444; border-radius: 6px;
            background: #252545; color: #fff; font-size: 13px;
        }
        
        .editor-table-wrapper { overflow-x: auto; background: #252545; border-radius: 8px; }
        .editor-table { width: 100%; border-collapse: collapse; min-width: 1050px; }
        .editor-table th {
            background: #3a3a5a; padding: 12px 10px; text-align: left;
            font-size: 12px; font-weight: 600; color: #fff; position: sticky; top: 0; z-index: 2;
        }
        .editor-table td { padding: 8px 10px; border-bottom: 1px solid #333; font-size: 13px; vertical-align: top; }
        .editor-table tr:hover { background: #2a2a4a; }
        .editor-table tr.completed-row { opacity: 0.5; }
        .editor-table tr.completed-row .task-name-input { text-decoration: line-through; color: #1abc9c; }
        .editor-table tr.dragging { opacity: 0.5; background: #667eea; }
        .editor-table tr.drag-over { border-top: 3px solid #667eea; }
        
        .drag-handle { cursor: grab; font-size: 18px; user-select: none; padding: 5px 10px; }
        .drag-handle:active { cursor: grabbing; }
        
        .editor-table tr.section-row { background: #1a1a2e; }
        .editor-table tr.section-row td {
            padding: 10px; font-weight: 600; color: #667eea; border-bottom: 2px solid #667eea;
        }
        
        .editor-table input[type="text"],
        .editor-table input[type="number"],
        .editor-table input[type="date"] {
            width: 100%; padding: 6px 8px; border: 1px solid #444;
            border-radius: 4px; background: #1a1a2e; color: #fff; font-size: 13px;
        }
        .editor-table input:focus { outline: none; border-color: #667eea; }
        .editor-table select {
            width: 100%; padding: 6px 8px; border: 1px solid #444;
            border-radius: 4px; background: #1a1a2e; color: #fff; font-size: 13px;
        }
        .editor-table .narrow { width: 80px; }
        .row-actions { display: flex; gap: 5px; flex-wrap: wrap; }
        
        /* Stages */
        .stages-container { margin-top: 6px; }
        .stage-row {
            display: flex; align-items: center; gap: 6px; padding: 3px 0;
            font-size: 12px; color: #bbb;
        }
        .stage-row input[type="checkbox"] { accent-color: #1abc9c; width: 16px; height: 16px; cursor: pointer; flex-shrink: 0; }
        .stage-row .stage-name { flex: 1; }
        .stage-row .stage-name-input {
            background: transparent; border: 1px solid transparent; color: #bbb;
            padding: 2px 4px; border-radius: 3px; font-size: 12px; width: 100%;
        }
        .stage-row .stage-name-input:focus { border-color: #667eea; background: #1a1a2e; color: #fff; }
        .stage-row.stage-completed .stage-name-input { text-decoration: line-through; color: #1abc9c; }
        .stage-row .stage-delete { color: #e74c3c; cursor: pointer; font-size: 14px; padding: 0 4px; opacity: 0.5; flex-shrink: 0; }
        .stage-row .stage-delete:hover { opacity: 1; }
        .add-stage-btn {
            display: inline-block; margin-top: 4px; font-size: 11px; color: #667eea;
            cursor: pointer; padding: 2px 6px; border-radius: 3px; border: 1px dashed #667eea40;
        }
        .add-stage-btn:hover { background: #667eea20; border-color: #667eea; }
        
        .stage-progress {
            display: flex; align-items: center; gap: 4px; margin-top: 4px; font-size: 10px; color: #888;
        }
        .stage-progress-bar { width: 50px; height: 4px; background: #1a1a2e; border-radius: 2px; overflow: hidden; }
        .stage-progress-fill { height: 100%; background: #1abc9c; border-radius: 2px; transition: width 0.3s; }
        
        .done-checkbox { width: 20px; height: 20px; cursor: pointer; accent-color: #1abc9c; }
        .done-cell { text-align: center; }
        
        .progress-info {
            display: flex; align-items: center; gap: 12px; padding: 12px 16px;
            background: #252545; border-radius: 8px; margin-bottom: 15px;
        }
        .progress-bar-container { background: #1a1a2e; border-radius: 10px; height: 10px; overflow: hidden; flex: 1; }
        .progress-bar-fill { height: 100%; border-radius: 10px; background: linear-gradient(90deg, #1abc9c, #27ae60); transition: width 0.5s ease; }
        .progress-text { font-size: 13px; color: #aaa; white-space: nowrap; }
        .progress-pct { font-size: 16px; font-weight: 700; color: #1abc9c; white-space: nowrap; }
        
        /* Gantt */
        .gantt-container { max-width: 1600px; margin: 0 auto; }
        .legend { display: flex; justify-content: center; gap: 20px; margin-bottom: 15px; flex-wrap: wrap; }
        .legend-item { display: flex; align-items: center; gap: 6px; font-size: 12px; }
        .legend-color { width: 16px; height: 16px; border-radius: 3px; }
        
        .gantt-wrapper { background: #252545; border-radius: 8px; overflow: hidden; }
        .gantt-scroll { overflow-x: auto; padding-bottom: 10px; }
        .gantt {
            display: grid; min-width: 2800px; gap: 1px; background: #1a1a2e;
            grid-template-columns: 280px repeat(140, 18px);
        }
        .month-row, .day-row, .task-row { display: contents; }
        .month-cell { background: #3a3a5a; padding: 5px 4px; font-size: 10px; font-weight: 600; text-align: center; color: #fff; }
        .month-cell.task-col { text-align: left; padding-left: 12px; }
        .day-cell { background: #2a2a4a; padding: 3px 2px; font-size: 8px; text-align: center; color: #888; }
        .day-cell.task-col { background: #3a3a5a; font-size: 10px; font-weight: 600; color: #fff; text-align: left; padding-left: 12px; }
        .day-cell.weekend { background: #222240; color: #555; }
        .day-cell.today { background: #667eea; color: #fff; font-weight: bold; }
        
        .section-header {
            grid-column: 1 / -1; background: #1a1a2e; padding: 8px 12px;
            font-weight: 600; font-size: 12px; color: #667eea; border-left: 3px solid #667eea;
        }
        .section-header.critical { color: #ff6b6b; border-left-color: #ff6b6b; }
        
        .task-name {
            background: #252545; padding: 8px 12px; font-size: 11px;
            display: flex; flex-direction: column; justify-content: center; border-left: 3px solid #667eea;
        }
        .task-name.delivery { border-left-color: #27ae60; }
        .task-name.decision { border-left-color: #3498db; }
        .task-name.work { border-left-color: #9b59b6; }
        .task-name.critical { border-left-color: #e74c3c; background: #2d2040; }
        .task-name.warning { border-left-color: #f39c12; }
        .task-name.done { border-left-color: #1abc9c; }
        .task-name.completed-task { border-left-color: #1abc9c !important; opacity: 0.55; }
        .task-name.completed-task .task-title { text-decoration: line-through; color: #1abc9c; }
        .task-name.is-stage { padding-left: 28px; background: #222240; border-left-style: dashed; font-size: 10px; }
        .task-name.is-stage .task-title { font-weight: 400; color: #bbb; }
        .task-name.is-stage.completed-task .task-title { color: #1abc9c; }
        
        .task-title { font-weight: 500; }
        .task-dates { font-size: 9px; color: #888; margin-top: 2px; }
        .task-note { font-size: 9px; color: #ff6b6b; margin-top: 1px; }
        .task-done-badge { font-size: 9px; color: #1abc9c; margin-top: 1px; }
        .task-stage-info { font-size: 9px; color: #667eea; margin-top: 1px; }
        
        .day-slot { background: #252545; position: relative; min-height: 36px; }
        .day-slot.weekend { background: #222240; }
        .day-slot.is-stage { min-height: 28px; background: #222240; }
        .day-slot.is-stage.weekend { background: #1e1e38; }
        
        .bar {
            position: absolute; top: 50%; transform: translateY(-50%);
            height: 20px; border-radius: 2px; left: 0; right: 0;
        }
        .bar.delivery { background: linear-gradient(135deg, #27ae60, #2ecc71); }
        .bar.decision { background: linear-gradient(135deg, #3498db, #5dade2); }
        .bar.work { background: linear-gradient(135deg, #9b59b6, #a569bd); }
        .bar.critical { background: linear-gradient(135deg, #e74c3c, #ec7063); }
        .bar.warning { background: linear-gradient(135deg, #f39c12, #f7b731); }
        .bar.done { background: linear-gradient(135deg, #1abc9c, #48c9b0); }
        .bar.completed-bar { background: linear-gradient(135deg, #1abc9c, #48c9b0) !important; opacity: 0.5; }
        .bar.stage-bar { height: 14px; opacity: 0.7; }
        
        .bar.start { border-radius: 2px 0 0 2px; }
        .bar.end { border-radius: 0 2px 2px 0; }
        .bar.single { border-radius: 2px; }
        .bar.middle { border-radius: 0; }
        
        .summary { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin-bottom: 20px; }
        .summary-card { background: #252545; border-radius: 8px; padding: 12px; text-align: center; }
        .summary-card .number { font-size: 20px; font-weight: 700; color: #667eea; }
        .summary-card .label { font-size: 10px; color: #888; margin-top: 4px; }
        .summary-card.warning .number { color: #f39c12; }
        .summary-card.critical .number { color: #e74c3c; }
        .summary-card.success .number { color: #27ae60; }
        
        .notes { margin-top: 25px; background: #252545; border-radius: 8px; padding: 15px; }
        .notes h2 { color: #ff6b6b; margin-bottom: 12px; font-size: 14px; }
        .notes-grid { display: grid; gap: 8px; }
        .note-item { padding: 10px 12px; background: #2d2545; border-radius: 5px; border-left: 3px solid #ff6b6b; font-size: 12px; }
        .note-item strong { color: #fff; }
        .note-item.info { border-left-color: #667eea; background: #252560; }
        
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center; }
        .modal.active { display: flex; }
        .modal-content { background: #252545; padding: 25px; border-radius: 10px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; }
        .modal-content h3 { margin-bottom: 15px; }
        .modal-content textarea { width: 100%; height: 300px; background: #1a1a2e; border: 1px solid #444; border-radius: 6px; color: #fff; padding: 10px; font-family: monospace; font-size: 12px; }
        .modal-buttons { display: flex; gap: 10px; margin-top: 15px; justify-content: flex-end; }
    </style>
</head>
<body>
    <h1>üè† Renovacijos Master Planas</h1>
    <p class="subtitle">Ker≈≥ Kerai 70m¬≤ ¬∑ Rangovas: Balsteta</p>
    
    <div class="tabs">
        <button class="tab active" onclick="switchTab('gantt')">üìä Gantt Grafikas</button>
        <button class="tab" onclick="switchTab('editor')">‚úèÔ∏è Redaguoti</button>
    </div>
    
    <div id="gantt-view" class="view active">
        <div class="gantt-container">
            <div class="summary" id="summary"></div>
            <div class="progress-info" id="gantt-progress"></div>
            
            <div class="legend">
                <div class="legend-item"><div class="legend-color" style="background:linear-gradient(135deg,#27ae60,#2ecc71)"></div><span>Pristatymai</span></div>
                <div class="legend-item"><div class="legend-color" style="background:linear-gradient(135deg,#3498db,#5dade2)"></div><span>Sprendimai</span></div>
                <div class="legend-item"><div class="legend-color" style="background:linear-gradient(135deg,#9b59b6,#a569bd)"></div><span>Darbai</span></div>
                <div class="legend-item"><div class="legend-color" style="background:linear-gradient(135deg,#e74c3c,#ec7063)"></div><span>Kritinis</span></div>
                <div class="legend-item"><div class="legend-color" style="background:linear-gradient(135deg,#f39c12,#f7b731)"></div><span>Dƒómesio</span></div>
                <div class="legend-item"><div class="legend-color" style="background:linear-gradient(135deg,#1abc9c,#48c9b0)"></div><span>Atlikta ‚úì</span></div>
            </div>
            
            <div class="gantt-wrapper"><div class="gantt-scroll"><div class="gantt" id="gantt"></div></div></div>
            
            <div class="notes">
                <h2>‚ö†Ô∏è Klausimai Balstetai</h2>
                <div class="notes-grid">
                    <div class="note-item"><strong>1. Nematomos durys:</strong> Kada pristatymas ir montavimas? PRIE≈† mikrocementƒÖ!</div>
                    <div class="note-item"><strong>2. Mikrocementas:</strong> Kada meistras? PO dur≈≥ montavimo!</div>
                    <div class="note-item"><strong>3. Parketas:</strong> Kada klojƒójai? Koordinuoti auk≈°ƒçius!</div>
                </div>
            </div>
            <div class="notes" style="margin-top:15px">
                <h2 style="color:#667eea">üìã Priklausomybƒós</h2>
                <div class="notes-grid">
                    <div class="note-item info"><strong>Sienos:</strong> Gipskartonis ‚Üí Glaistymas ‚Üí Durys ‚Üí Mikrocementas ‚Üí Da≈æymas</div>
                    <div class="note-item info"><strong>Grindys:</strong> Auk≈°ƒçiai ≈æinoti iki 02-09</div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="editor-view" class="view">
        <div class="editor-container">
            <div class="toolbar">
                <label>Projekto prad≈æia: </label>
                <input type="date" id="startDate" class="start-date-input" value="2025-01-26" onchange="updateAll()">
                <button class="btn btn-success" onclick="addTask()">‚ûï U≈æduotis</button>
                <button class="btn btn-primary" onclick="addSection()">üìÅ Sekcija</button>
                <button class="btn btn-secondary" onclick="exportData()">üíæ Eksportuoti</button>
                <button class="btn btn-secondary" onclick="importData()">üìÇ Importuoti</button>
            </div>
            <div class="progress-info" id="editor-progress"></div>
            
            <div class="editor-table-wrapper">
                <table class="editor-table">
                    <thead>
                        <tr>
                            <th style="width:40px"></th>
                            <th style="width:35px">‚úì</th>
                            <th style="width:250px">U≈æduotis / Etapai</th>
                            <th style="width:95px">Tipas</th>
                            <th style="width:110px">Prad≈æia</th>
                            <th style="width:55px">Dien≈≥</th>
                            <th style="width:110px">Pabaiga</th>
                            <th>Pastaba</th>
                            <th style="width:75px"></th>
                        </tr>
                    </thead>
                    <tbody id="taskTable"></tbody>
                </table>
            </div>
        </div>
    </div>
    
    <div class="modal" id="modal">
        <div class="modal-content">
            <h3 id="modalTitle">Eksportuoti</h3>
            <textarea id="modalData"></textarea>
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeModal()">U≈ædaryti</button>
                <button class="btn btn-primary" id="modalAction" onclick="copyData()">Kopijuoti</button>
            </div>
        </div>
    </div>

<script>
// ===== DATE HELPERS =====
function parseLocalDate(s){const p=s.split('-');return new Date(+p[0],+p[1]-1,+p[2])}
function formatDate(d){return`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`}
function addDays(d,n){const r=new Date(d);r.setDate(r.getDate()+n);return r}
function daysBetween(a,b){return Math.round((new Date(b.getFullYear(),b.getMonth(),b.getDate())-new Date(a.getFullYear(),a.getMonth(),a.getDate()))/864e5)}
function isWeekend(d){const w=d.getDay();return w===0||w===6}
function getMonthName(d){return d.toLocaleDateString('lt-LT',{month:'short',year:'numeric'})}
function todayLocal(){const n=new Date();return new Date(n.getFullYear(),n.getMonth(),n.getDate())}
function escapeHtml(s){const d=document.createElement('div');d.textContent=s;return d.innerHTML}

// ===== DATA =====
let projectStart = parseLocalDate('2025-01-26');

let tasks = [
    { type:'section', name:'üì¶ PRISTATYMAI IR SPRENDIMAI' },
    { name:'Potinkinƒó santechnika, WC rƒómas, trapas', category:'delivery', startDay:0, duration:7, note:'', completed:false, stages:[] },
    { name:'Parketo/plyteli≈≥ auk≈°ƒçiai - ≈æinoti', category:'decision', startDay:7, duration:7, note:'Kritinis terminas!', completed:false, stages:[] },
    { name:'≈†viestuv≈≥ laid≈≥ i≈°siki≈°imas', category:'decision', startDay:7, duration:7, note:'', completed:false, stages:[] },
    { name:'Signalizacija', category:'delivery', startDay:7, duration:14, note:'', completed:false,
      stages:[{name:'1. Kabeli≈≥ instaliacija',completed:false},{name:'2. Davikli≈≥/centralƒós montavimas',completed:false}] },
    { name:'Plyteli≈≥ pristatymas', category:'delivery', startDay:14, duration:14, note:'3-4 sav', completed:false, stages:[] },
    { name:'Spalv≈≥ pasirinkimas (da≈æai)', category:'decision', startDay:42, duration:7, note:'7 sav', completed:false, stages:[] },
    { name:'Rozetƒós, jungikliai, ≈°viestuvai, santechnika', category:'delivery', startDay:56, duration:7, note:'9 sav', completed:false, stages:[] },
    { name:'Difuzoriai (Ventman) - pristatyti', category:'delivery', startDay:14, duration:7, note:'Prie≈° gipskartonƒØ', completed:false, stages:[] },
    
    { type:'section', name:'‚ö†Ô∏è KRITINIAI - I≈†SIAI≈†KINTI SU BALSTETA', critical:true },
    { name:'Nematomos durys (1vnt vonia‚Üîpagalbinƒó)', category:'critical', startDay:28, duration:14, note:'‚ùì PRIE≈† mikrocementƒÖ!', completed:false, stages:[] },
    { name:'Mikrocementas (sienos + stakta)', category:'critical', startDay:42, duration:10, note:'‚ùì PO dur≈≥ montavimo!', completed:false, stages:[] },
    { name:'Parketo klojimas', category:'warning', startDay:56, duration:10, note:'‚ùì Klausti Balstetos kada', completed:false, stages:[] },
    
    { type:'section', name:'‚è∞ U≈ΩSAKYTI LAIKU (nepamesti!)' },
    { name:'Spintos - susirasti gamintojƒÖ', category:'warning', startDay:14, duration:14, note:'Ie≈°koti DABAR', completed:false, stages:[] },
    { name:'Spintos - galutinis matavimas', category:'decision', startDay:42, duration:3, note:'Kai sienos baigtos', completed:false, stages:[] },
    { name:'Vonios baldas - i≈°sirinkti ir u≈æsakyti', category:'warning', startDay:21, duration:21, note:'Reikia prie≈° kriauklƒô!', completed:false, stages:[] },
    { name:'Veidrod≈æiai - i≈°sirinkti', category:'decision', startDay:49, duration:14, note:'Laidas jau i≈°vestas', completed:false, stages:[] },
    
    { type:'section', name:'üî® DARBAI - PARUO≈†IMAS' },
    { name:'Griovimo darbai', category:'work', startDay:0, duration:7, note:'', completed:false, stages:[] },
    { name:'Elektros instaliacija', category:'work', startDay:7, duration:14, note:'', completed:false,
      stages:[{name:'1. Potinkinƒó (kabeliai, dƒó≈æutƒós)',completed:false},{name:'2. Apdaila (rozetƒós, jungikliai, ≈°viestuvai)',completed:false}] },
    { name:'Santechnikos instaliacija', category:'work', startDay:7, duration:14, note:'', completed:false,
      stages:[{name:'1. Potinkinƒó (vamzd≈æiai, trapas, WC rƒómas)',completed:false},{name:'2. Apdaila (kriauklƒó, WC, du≈°as, mai≈°ytuvai)',completed:false}] },
    { name:'Ventiliacijos montavimas (Vallox 099 + difuzoriai)', category:'work', startDay:14, duration:10, note:'', completed:false, stages:[] },
    { name:'Gipskartonio darbai', category:'work', startDay:21, duration:14, note:'', completed:false, stages:[] },
    { name:'Grind≈≥ ≈°ildymo instaliacija', category:'work', startDay:28, duration:10, note:'', completed:false, stages:[] },
    
    { type:'section', name:'üî® DARBAI - APDAILA' },
    { name:'Glaistymas', category:'work', startDay:35, duration:10, note:'', completed:false, stages:[] },
    { name:'Da≈æymas', category:'work', startDay:52, duration:10, note:'Po mikrocemento', completed:false, stages:[] },
    { name:'Plytelƒós - vonia', category:'work', startDay:56, duration:7, note:'', completed:false, stages:[] },
    { name:'Plytelƒós - pagalbinƒó patalpa', category:'work', startDay:63, duration:4, note:'', completed:false, stages:[] },
    { name:'Plytelƒós - virtuvƒó/prie≈°kambaris', category:'work', startDay:67, duration:5, note:'', completed:false, stages:[] },
    
    { type:'section', name:'üî® DARBAI - MONTAVIMAS' },
    { name:'Paprastos durys - montavimas', category:'work', startDay:70, duration:3, note:'Po da≈æymo, prie≈° grindjuostes', completed:false, stages:[] },
    { name:'Vonios baldas - montavimas', category:'work', startDay:70, duration:2, note:'', completed:false, stages:[] },
    { name:'Spintos - montavimas', category:'work', startDay:77, duration:5, note:'~4-6 sav po matavimo', completed:false, stages:[] },
    { name:'Veidrod≈æiai - montavimas', category:'work', startDay:77, duration:2, note:'', completed:false, stages:[] },
    { name:'Grindjuostƒós', category:'work', startDay:82, duration:3, note:'Po spint≈≥!', completed:false, stages:[] },
    { name:'Skalbimo ma≈°inos prijungimas', category:'work', startDay:77, duration:1, note:'Pagalbinƒó patalpa', completed:false, stages:[] },
    { name:'Baigiamieji darbai, valymas', category:'work', startDay:85, duration:7, note:'', completed:false, stages:[] },
    
    { type:'section', name:'‚úÖ JAU U≈ΩSAKYTA / NUPIRKTA' },
    { name:'Vallox 099 entalpinis rekuperatorius', category:'done', startDay:0, duration:1, note:'', completed:true, stages:[] },
    { name:'Difuzoriai (Ventman)', category:'done', startDay:0, duration:1, note:'', completed:true, stages:[] },
    { name:'Alice Ceramica vonios keramika', category:'done', startDay:0, duration:1, note:'', completed:true, stages:[] },
    { name:'Hansgrohe mai≈°ytuvai', category:'done', startDay:0, duration:1, note:'', completed:true, stages:[] },
    
    { type:'section', name:'‚è∏Ô∏è 2 ETAPAS (vƒóliau)' },
    { name:'Virtuvƒós baldai - matavimas', category:'decision', startDay:92, duration:1, note:'Kai bus pinig≈≥', completed:false, stages:[] },
    { name:'Virtuvƒós baldai - gamyba', category:'delivery', startDay:93, duration:30, note:'~4-6 sav', completed:false, stages:[] },
    { name:'Virtuvƒós baldai - montavimas', category:'work', startDay:123, duration:3, note:'', completed:false, stages:[] },
    { name:'Buitinƒó technika', category:'delivery', startDay:123, duration:3, note:'Orkaitƒó, kaitlentƒó, indaplovƒó', completed:false, stages:[] },
];

const categories = {
    delivery:{name:'Pristatymas',color:'#27ae60'}, decision:{name:'Sprendimas',color:'#3498db'},
    work:{name:'Darbai',color:'#9b59b6'}, critical:{name:'Kritinis',color:'#e74c3c'},
    warning:{name:'Dƒómesio',color:'#f39c12'}, done:{name:'Atlikta',color:'#1abc9c'}
};

// ===== HELPERS =====
function isTaskCompleted(t){if(t.type)return false;if(t.stages&&t.stages.length>0)return t.stages.every(s=>s.completed);return t.completed}
function getStageProgress(t){if(!t.stages||!t.stages.length)return null;const d=t.stages.filter(s=>s.completed).length;return{done:d,total:t.stages.length,pct:Math.round(d/t.stages.length*100)}}
function syncTaskCompleted(t){if(t.stages&&t.stages.length>0)t.completed=t.stages.every(s=>s.completed)}

function getProgress(){
    const r=tasks.filter(t=>!t.type);const total=r.length;
    const completed=r.filter(t=>isTaskCompleted(t)).length;
    return{total,completed,pct:total?Math.round(completed/total*100):0}
}
function renderProgress(id){
    const{total,completed,pct}=getProgress();
    document.getElementById(id).innerHTML=`
        <span class="progress-pct">${pct}%</span>
        <div class="progress-bar-container"><div class="progress-bar-fill" style="width:${pct}%"></div></div>
        <span class="progress-text">${completed} i≈° ${total} u≈æduoƒçi≈≥ atlikta</span>`;
}

// ===== TAB =====
function switchTab(tab){
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
    document.querySelector(`.tab[onclick="switchTab('${tab}')"]`).classList.add('active');
    document.getElementById(`${tab}-view`).classList.add('active');
    if(tab==='gantt')renderGantt();
}

// ===== EDITOR =====
function renderEditor(){
    const tbody=document.getElementById('taskTable');
    tbody.innerHTML='';
    
    tasks.forEach((task,index)=>{
        const tr=document.createElement('tr');
        tr.draggable=true; tr.dataset.index=index;
        
        tr.addEventListener('dragstart',e=>{tr.classList.add('dragging');e.dataTransfer.setData('text/plain',index)});
        tr.addEventListener('dragend',()=>{tr.classList.remove('dragging');document.querySelectorAll('.drag-over').forEach(el=>el.classList.remove('drag-over'))});
        tr.addEventListener('dragover',e=>{e.preventDefault();tr.classList.add('drag-over')});
        tr.addEventListener('dragleave',()=>tr.classList.remove('drag-over'));
        tr.addEventListener('drop',e=>{
            e.preventDefault();tr.classList.remove('drag-over');
            const from=parseInt(e.dataTransfer.getData('text/plain'));
            if(from!==index){const item=tasks.splice(from,1)[0];tasks.splice(index,0,item);saveToStorage();renderEditor()}
        });
        
        if(task.type==='section'){
            tr.className='section-row';
            tr.innerHTML=`<td class="drag-handle">‚ò∞</td><td></td>
                <td colspan="5"><input type="text" value="${escapeHtml(task.name)}" onchange="updateTask(${index},'name',this.value)"></td>
                <td></td><td><div class="row-actions"><button class="btn btn-danger btn-small" onclick="deleteTask(${index})">üóëÔ∏è</button></div></td>`;
        } else {
            const sDate=addDays(projectStart,task.startDay);
            const eDate=addDays(projectStart,task.startDay+task.duration);
            const done=isTaskCompleted(task);
            const hasStages=task.stages&&task.stages.length>0;
            const sp=getStageProgress(task);
            
            if(done)tr.classList.add('completed-row');
            
            let stagesHtml='<div class="stages-container">';
            if(hasStages){
                task.stages.forEach((stage,si)=>{
                    const sc=stage.completed?' stage-completed':'';
                    stagesHtml+=`<div class="stage-row${sc}">
                        <input type="checkbox" ${stage.completed?'checked':''} onchange="toggleStage(${index},${si},this.checked)">
                        <div class="stage-name"><input type="text" class="stage-name-input" value="${escapeHtml(stage.name)}" onchange="updateStageName(${index},${si},this.value)"></div>
                        <span class="stage-delete" onclick="deleteStage(${index},${si})">‚úï</span>
                    </div>`;
                });
                stagesHtml+=`<div class="stage-progress"><div class="stage-progress-bar"><div class="stage-progress-fill" style="width:${sp.pct}%"></div></div><span>${sp.done}/${sp.total}</span></div>`;
            }
            stagesHtml+=`<span class="add-stage-btn" onclick="addStage(${index})">+ etapas</span></div>`;
            
            tr.innerHTML=`<td class="drag-handle">‚ò∞</td>
                <td class="done-cell">${hasStages
                    ?`<span style="font-size:16px;color:${done?'#1abc9c':'#555'}">${done?'‚úÖ':'‚è≥'}</span>`
                    :`<input type="checkbox" class="done-checkbox" ${done?'checked':''} onchange="toggleCompleted(${index},this.checked)" title="Pa≈æymƒóti kaip atliktƒÖ">`}</td>
                <td><input type="text" class="task-name-input" value="${escapeHtml(task.name)}" onchange="updateTask(${index},'name',this.value)">${stagesHtml}</td>
                <td><select onchange="updateTask(${index},'category',this.value)">
                    ${Object.entries(categories).map(([k,v])=>`<option value="${k}" ${task.category===k?'selected':''}>${v.name}</option>`).join('')}</select></td>
                <td><input type="date" value="${formatDate(sDate)}" onchange="updateStartDate(${index},this.value)"></td>
                <td><input type="number" value="${task.duration}" min="1" class="narrow" onchange="updateTask(${index},'duration',parseInt(this.value))"></td>
                <td><input type="date" value="${formatDate(eDate)}" onchange="updateEndDate(${index},this.value)" style="color:#aaa"></td>
                <td><input type="text" value="${escapeHtml(task.note||'')}" onchange="updateTask(${index},'note',this.value)" placeholder="Pastaba..."></td>
                <td><div class="row-actions"><button class="btn btn-danger btn-small" onclick="deleteTask(${index})">üóëÔ∏è</button></div></td>`;
        }
        tbody.appendChild(tr);
    });
    renderProgress('editor-progress');
}

function updateTask(i,f,v){tasks[i][f]=v;saveToStorage();renderEditor()}

// Changing START date: keep DURATION fixed ‚Üí end date moves
function updateStartDate(i,ds){
    const newStart=parseLocalDate(ds);
    tasks[i].startDay=daysBetween(projectStart,newStart);
    // duration stays the same, end date auto-recalculates
    saveToStorage();renderEditor();
}

// Changing END date: keep START fixed ‚Üí recalculate duration
function updateEndDate(i,ds){
    const newEnd=parseLocalDate(ds);
    const curStart=addDays(projectStart, tasks[i].startDay);
    const newDur=daysBetween(curStart,newEnd);
    tasks[i].duration=Math.max(1,newDur);
    saveToStorage();renderEditor();
}
function toggleCompleted(i,c){tasks[i].completed=c;saveToStorage();renderEditor()}
function deleteTask(i){if(confirm('I≈°trinti?')){tasks.splice(i,1);saveToStorage();renderEditor()}}
function addTask(){tasks.push({name:'Nauja u≈æduotis',category:'work',startDay:0,duration:7,note:'',completed:false,stages:[]});saveToStorage();renderEditor()}
function addSection(){tasks.push({type:'section',name:'üìÅ Nauja sekcija'});saveToStorage();renderEditor()}

function addStage(ti){
    if(!tasks[ti].stages)tasks[ti].stages=[];
    tasks[ti].stages.push({name:`${tasks[ti].stages.length+1}. Naujas etapas`,completed:false});
    syncTaskCompleted(tasks[ti]);saveToStorage();renderEditor();
}
function toggleStage(ti,si,c){tasks[ti].stages[si].completed=c;syncTaskCompleted(tasks[ti]);saveToStorage();renderEditor()}
function updateStageName(ti,si,v){tasks[ti].stages[si].name=v;saveToStorage()}
function deleteStage(ti,si){tasks[ti].stages.splice(si,1);syncTaskCompleted(tasks[ti]);saveToStorage();renderEditor()}

// ===== GANTT =====
function renderGantt(){
    const gantt=document.getElementById('gantt');
    const totalDays=140;const today=todayLocal();let html='';
    
    // Months
    html+='<div class="month-row"><div class="month-cell task-col">U≈æduotis</div>';
    let months=[],cm=null,cnt=0;
    for(let i=0;i<totalDays;i++){const mn=getMonthName(addDays(projectStart,i));if(mn!==cm){if(cm)months.push({name:cm,span:cnt});cm=mn;cnt=1}else cnt++}
    months.push({name:cm,span:cnt});
    months.forEach(m=>html+=`<div class="month-cell" style="grid-column:span ${m.span}">${m.name}</div>`);
    html+='</div>';
    
    // Days
    html+='<div class="day-row"><div class="day-cell task-col">Prad≈æia ‚Üí Pabaiga</div>';
    for(let i=0;i<totalDays;i++){
        const d=addDays(projectStart,i);const wk=isWeekend(d)?' weekend':'';const td=d.toDateString()===today.toDateString()?' today':'';
        html+=`<div class="day-cell${wk}${td}">${d.getDate()}</div>`;
    }
    html+='</div>';
    
    // Tasks
    for(const task of tasks){
        if(task.type==='section'){html+=`<div class="section-header${task.critical?' critical':''}">${task.name}</div>`;continue}
        
        const sDate=addDays(projectStart,task.startDay);
        const eDate=addDays(projectStart,task.startDay+task.duration);
        const dateStr=`${formatDate(sDate)} ‚Üí ${formatDate(eDate)}`;
        const done=isTaskCompleted(task);
        const hasStages=task.stages&&task.stages.length>0;
        const sp=getStageProgress(task);
        
        // Main row
        html+='<div class="task-row">';
        html+=`<div class="task-name ${task.category}${done?' completed-task':''}">
            <div class="task-title">${done?'‚úì ':''}${task.name}</div>
            <div class="task-dates">${dateStr}</div>
            ${done?'<div class="task-done-badge">‚úÖ Atlikta</div>':''}
            ${hasStages&&!done?`<div class="task-stage-info">‚è≥ ${sp.done}/${sp.total} etap≈≥</div>`:''}
            ${!done&&!hasStages&&task.note?`<div class="task-note">${task.note}</div>`:''}
        </div>`;
        
        for(let i=0;i<totalDays;i++){
            const wk=isWeekend(addDays(projectStart,i))?' weekend':'';
            const inR=i>=task.startDay&&i<task.startDay+task.duration;
            if(inR){
                let bc=done?'completed-bar':task.category;
                if(task.duration===1)bc+=' single';else if(i===task.startDay)bc+=' start';else if(i===task.startDay+task.duration-1)bc+=' end';else bc+=' middle';
                html+=`<div class="day-slot"><div class="bar ${bc}"></div></div>`;
            }else html+=`<div class="day-slot${wk}"></div>`;
        }
        html+='</div>';
        
        // Stage sub-rows
        if(hasStages){
            const sDur=Math.max(1,Math.floor(task.duration/task.stages.length));
            task.stages.forEach((stage,si)=>{
                const ss=task.startDay+si*sDur;
                const se=(si===task.stages.length-1)?task.startDay+task.duration:ss+sDur;
                const sd=stage.completed;
                
                html+='<div class="task-row">';
                html+=`<div class="task-name is-stage ${task.category}${sd?' completed-task':''}">
                    <div class="task-title">${sd?'‚úì ':'‚óã '}${stage.name}</div></div>`;
                
                for(let i=0;i<totalDays;i++){
                    const wk=isWeekend(addDays(projectStart,i))?' weekend':'';
                    const inR=i>=ss&&i<se;
                    if(inR){
                        let bc=sd?'completed-bar stage-bar':task.category+' stage-bar';
                        const len=se-ss;
                        if(len===1)bc+=' single';else if(i===ss)bc+=' start';else if(i===se-1)bc+=' end';else bc+=' middle';
                        html+=`<div class="day-slot is-stage"><div class="bar ${bc}"></div></div>`;
                    }else html+=`<div class="day-slot is-stage${wk}"></div>`;
                }
                html+='</div>';
            });
        }
    }
    
    gantt.innerHTML=html;
    updateSummary();renderProgress('gantt-progress');
}

function updateSummary(){
    const real=tasks.filter(t=>!t.type);
    const maxEnd=Math.max(...real.map(t=>t.startDay+t.duration));
    const endDate=addDays(projectStart,maxEnd);
    const crit=real.filter(t=>!isTaskCompleted(t)&&(t.category==='critical'||t.category==='warning')).length;
    const{completed}=getProgress();
    
    document.getElementById('summary').innerHTML=`
        <div class="summary-card"><div class="number">${formatDate(projectStart).slice(5)}</div><div class="label">Prad≈æia</div></div>
        <div class="summary-card"><div class="number">${maxEnd} d.</div><div class="label">Trukmƒó</div></div>
        <div class="summary-card"><div class="number">${formatDate(endDate).slice(5)}</div><div class="label">Pabaiga</div></div>
        <div class="summary-card critical"><div class="number">${crit}</div><div class="label">Kritiniai</div></div>
        <div class="summary-card success"><div class="number">${completed}</div><div class="label">Atlikta ‚úì</div></div>`;
}

function updateAll(){projectStart=parseLocalDate(document.getElementById('startDate').value);saveToStorage();renderEditor()}

// ===== EXPORT/IMPORT =====
function exportData(){
    document.getElementById('modalTitle').textContent='Eksportuoti duomenis';
    document.getElementById('modalData').value=JSON.stringify({projectStart:formatDate(projectStart),tasks},null,2);
    document.getElementById('modalAction').textContent='Kopijuoti';
    document.getElementById('modalAction').onclick=copyData;
    document.getElementById('modal').classList.add('active');
}
function importData(){
    document.getElementById('modalTitle').textContent='Importuoti duomenis';
    document.getElementById('modalData').value='';
    document.getElementById('modalAction').textContent='Importuoti';
    document.getElementById('modalAction').onclick=doImport;
    document.getElementById('modal').classList.add('active');
}
function copyData(){
    const ta=document.getElementById('modalData');ta.select();
    navigator.clipboard.writeText(ta.value).then(()=>alert('Nukopijuota!')).catch(()=>{document.execCommand('copy');alert('Nukopijuota!')});
}
function doImport(){
    try{
        const data=JSON.parse(document.getElementById('modalData').value);
        if(data.projectStart){projectStart=parseLocalDate(data.projectStart);document.getElementById('startDate').value=data.projectStart}
        if(data.tasks){tasks=data.tasks.map(t=>{if(!t.type){if(t.completed===undefined)t.completed=false;if(!t.stages)t.stages=[]}return t})}
        saveToStorage();renderEditor();closeModal();alert('Importuota sƒókmingai!');
    }catch(e){alert('Klaida: neteisingas formatas')}
}
function closeModal(){document.getElementById('modal').classList.remove('active')}

function saveToStorage(){}
function loadFromStorage(){}

loadFromStorage();renderEditor();renderGantt();
</script>
</body>
</html>
