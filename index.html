<!DOCTYPE html>
<html lang="lt">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Renovacijos Master Planas</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#1a1a2e;color:#eee;padding:16px;min-height:100vh}
h1{text-align:center;margin-bottom:4px;color:#fff;font-size:22px}
.sub{text-align:center;color:#888;margin-bottom:16px;font-size:13px}
.tabs{display:flex;gap:8px;margin-bottom:16px;justify-content:center}
.tab{padding:9px 22px;background:#252545;border:none;color:#aaa;cursor:pointer;border-radius:8px;font-size:13px;transition:.2s}
.tab:hover{background:#353565}.tab.active{background:#667eea;color:#fff}
.view{display:none}.view.active{display:block}

/* Buttons */
.btn{padding:7px 14px;border:none;border-radius:6px;cursor:pointer;font-size:12px;transition:.2s}
.btn-p{background:#667eea;color:#fff}.btn-p:hover{background:#5a6fd6}
.btn-g{background:#27ae60;color:#fff}.btn-g:hover{background:#219a52}
.btn-d{background:#e74c3c;color:#fff}.btn-d:hover{background:#c0392b}
.btn-s{background:#555;color:#fff}.btn-s:hover{background:#666}
.btn-sm{padding:3px 7px;font-size:10px}

/* Progress */
.prog{display:flex;align-items:center;gap:10px;padding:10px 14px;background:#252545;border-radius:8px;margin-bottom:12px}
.prog-bar{flex:1;height:8px;background:#1a1a2e;border-radius:8px;overflow:hidden}
.prog-fill{height:100%;border-radius:8px;background:linear-gradient(90deg,#1abc9c,#27ae60);transition:width .4s}
.prog-txt{font-size:12px;color:#aaa;white-space:nowrap}
.prog-pct{font-size:15px;font-weight:700;color:#1abc9c;white-space:nowrap}

/* Editor */
.ed-wrap{max-width:1500px;margin:0 auto}
.toolbar{display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap;align-items:center}
.dt-in{padding:7px 10px;border:1px solid #444;border-radius:6px;background:#252545;color:#fff;font-size:12px}
.tw{overflow-x:auto;background:#252545;border-radius:8px}
table.ed{width:100%;border-collapse:collapse;min-width:1150px}
.ed th{background:#3a3a5a;padding:10px 6px;text-align:left;font-size:10px;font-weight:600;color:#fff;position:sticky;top:0;z-index:2;white-space:nowrap}
.ed td{padding:5px 6px;border-bottom:1px solid #333;font-size:12px;vertical-align:top}
.ed tr:hover{background:#2a2a4a}
.ed tr.cpl{opacity:.5}
.ed tr.cpl .tn{text-decoration:line-through;color:#1abc9c}
.ed tr.drag{opacity:.5;background:#667eea}
.ed tr.dov{border-top:3px solid #667eea}
.dh{cursor:grab;font-size:16px;user-select:none;padding:4px 6px}.dh:active{cursor:grabbing}
.ed tr.sec{background:#1a1a2e}
.ed tr.sec td{padding:8px;font-weight:600;color:#667eea;border-bottom:2px solid #667eea}
.ed input[type="text"],.ed input[type="number"],.ed input[type="date"]{
  width:100%;padding:4px 5px;border:1px solid #444;border-radius:4px;background:#1a1a2e;color:#fff;font-size:11px}
.ed input:focus{outline:none;border-color:#667eea}
.ed select{width:100%;padding:4px 5px;border:1px solid #444;border-radius:4px;background:#1a1a2e;color:#fff;font-size:11px}
.nar{width:50px}
.dur-ro{color:#667eea;font-size:11px;font-weight:600;text-align:center;padding:5px 2px}
.chk{width:18px;height:18px;cursor:pointer;accent-color:#1abc9c}
.chk-c{text-align:center}

/* Stages in editor */
.stg-wrap{margin-top:5px;border-top:1px dashed #444;padding-top:4px}
.stg{display:flex;align-items:center;gap:4px;padding:2px 0;font-size:11px;color:#bbb}
.stg input[type="checkbox"]{accent-color:#1abc9c;width:14px;height:14px;cursor:pointer;flex-shrink:0}
.stg .sn{flex:1}
.stg .sn input{background:transparent;border:1px solid transparent;color:#bbb;padding:2px 4px;font-size:11px;width:100%}
.stg .sn input:focus{border-color:#667eea;background:#1a1a2e;color:#fff}
.stg.done .sn input{text-decoration:line-through;color:#1abc9c}
.stg .sd-in{width:90px;flex-shrink:0}
.stg .sd-dur{width:45px;flex-shrink:0}
.stg .sx{color:#e74c3c;cursor:pointer;font-size:12px;padding:0 3px;opacity:.4;flex-shrink:0}
.stg .sx:hover{opacity:1}
.add-stg{display:inline-block;margin-top:3px;font-size:10px;color:#667eea;cursor:pointer;padding:2px 6px;border-radius:3px;border:1px dashed #667eea40}
.add-stg:hover{background:#667eea20;border-color:#667eea}
.stg-prog{display:flex;align-items:center;gap:4px;margin-top:3px;font-size:9px;color:#888}
.stg-pb{width:40px;height:3px;background:#1a1a2e;border-radius:2px;overflow:hidden}
.stg-pf{height:100%;background:#1abc9c;border-radius:2px}

/* Gantt */
.gc{max-width:1600px;margin:0 auto}
.legend{display:flex;justify-content:center;gap:16px;margin-bottom:12px;flex-wrap:wrap}
.lg-i{display:flex;align-items:center;gap:5px;font-size:11px}
.lg-c{width:14px;height:14px;border-radius:3px}
.gw{background:#252545;border-radius:8px;overflow:hidden}
.gs{overflow-x:auto;padding-bottom:8px}
.gantt{display:grid;min-width:2800px;gap:1px;background:#1a1a2e;grid-template-columns:260px repeat(140,18px)}
.mr,.dr,.tr{display:contents}
.mc{background:#3a3a5a;padding:4px 3px;font-size:9px;font-weight:600;text-align:center;color:#fff}
.mc.tc{text-align:left;padding-left:10px}
.dc{background:#2a2a4a;padding:2px;font-size:8px;text-align:center;color:#888}
.dc.tc{background:#3a3a5a;font-size:9px;font-weight:600;color:#fff;text-align:left;padding-left:10px}
.dc.we{background:#222240;color:#555}
.dc.td{background:#667eea;color:#fff;font-weight:bold}
.sh{grid-column:1/-1;background:#1a1a2e;padding:7px 10px;font-weight:600;font-size:11px;color:#667eea;border-left:3px solid #667eea}
.sh.cr{color:#ff6b6b;border-left-color:#ff6b6b}
.tn-g{background:#252545;padding:6px 10px;font-size:10px;display:flex;flex-direction:column;justify-content:center;border-left:3px solid #667eea}
.tn-g.delivery{border-left-color:#27ae60}.tn-g.decision{border-left-color:#3498db}
.tn-g.work{border-left-color:#9b59b6}.tn-g.critical{border-left-color:#e74c3c;background:#2d2040}
.tn-g.warning{border-left-color:#f39c12}.tn-g.done{border-left-color:#1abc9c}
.tn-g.cpl{border-left-color:#1abc9c!important;opacity:.55}
.tn-g.cpl .tt{text-decoration:line-through;color:#1abc9c}
.tn-g.is-stg{padding-left:24px;background:#222240;border-left-style:dashed;font-size:9px}
.tn-g.is-stg .tt{font-weight:400;color:#bbb}
.tn-g.is-stg.cpl .tt{color:#1abc9c}
.tt{font-weight:500}.td-g{font-size:8px;color:#888;margin-top:1px}
.tn-g .note{font-size:8px;color:#ff6b6b;margin-top:1px}
.tn-g .badge{font-size:8px;color:#1abc9c;margin-top:1px}
.tn-g .si{font-size:8px;color:#667eea;margin-top:1px}
.ds{background:#252545;position:relative;min-height:32px}
.ds.we{background:#222240}
.ds.is-stg{min-height:24px;background:#222240}.ds.is-stg.we{background:#1e1e38}
.bar{position:absolute;top:50%;transform:translateY(-50%);height:18px;border-radius:2px;left:0;right:0}
.bar.delivery{background:linear-gradient(135deg,#27ae60,#2ecc71)}
.bar.decision{background:linear-gradient(135deg,#3498db,#5dade2)}
.bar.work{background:linear-gradient(135deg,#9b59b6,#a569bd)}
.bar.critical{background:linear-gradient(135deg,#e74c3c,#ec7063)}
.bar.warning{background:linear-gradient(135deg,#f39c12,#f7b731)}
.bar.done{background:linear-gradient(135deg,#1abc9c,#48c9b0)}
.bar.cpl-bar{background:linear-gradient(135deg,#1abc9c,#48c9b0)!important;opacity:.5}
.bar.stg-bar{height:12px;opacity:.7}
.bar.start{border-radius:2px 0 0 2px}.bar.end{border-radius:0 2px 2px 0}
.bar.single{border-radius:2px}.bar.middle{border-radius:0}

/* Summary */
.sum{display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:10px;margin-bottom:16px}
.sc{background:#252545;border-radius:8px;padding:10px;text-align:center}
.sc .n{font-size:18px;font-weight:700;color:#667eea}.sc .l{font-size:9px;color:#888;margin-top:3px}
.sc.cr .n{color:#e74c3c}.sc.ok .n{color:#27ae60}

/* Notes */
.notes{margin-top:20px;background:#252545;border-radius:8px;padding:12px}
.notes h2{color:#ff6b6b;margin-bottom:10px;font-size:13px}
.ng{display:grid;gap:6px}
.ni{padding:8px 10px;background:#2d2545;border-radius:5px;border-left:3px solid #ff6b6b;font-size:11px}
.ni strong{color:#fff}.ni.info{border-left-color:#667eea;background:#252560}

/* Modal */
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.8);z-index:1000;justify-content:center;align-items:center}
.modal.active{display:flex}
.modal-c{background:#252545;padding:20px;border-radius:10px;max-width:600px;width:90%;max-height:80vh;overflow-y:auto}
.modal-c h3{margin-bottom:12px}
.modal-c textarea{width:100%;height:280px;background:#1a1a2e;border:1px solid #444;border-radius:6px;color:#fff;padding:8px;font-family:monospace;font-size:11px}
.modal-b{display:flex;gap:8px;margin-top:12px;justify-content:flex-end}
</style>
</head>
<body>
<h1>üè† Renovacijos Master Planas</h1>
<p class="sub">Ker≈≥ Kerai 70m¬≤ ¬∑ Rangovas: Balsteta</p>

<div class="tabs">
  <button class="tab active" onclick="switchTab('gantt')">üìä Gantt</button>
  <button class="tab" onclick="switchTab('editor')">‚úèÔ∏è Redaguoti</button>
</div>

<!-- GANTT -->
<div id="gantt-view" class="view active">
<div class="gc">
  <div class="sum" id="summary"></div>
  <div class="prog" id="gp"></div>
  <div class="legend">
    <div class="lg-i"><div class="lg-c" style="background:linear-gradient(135deg,#27ae60,#2ecc71)"></div>Pristatymai</div>
    <div class="lg-i"><div class="lg-c" style="background:linear-gradient(135deg,#3498db,#5dade2)"></div>Sprendimai</div>
    <div class="lg-i"><div class="lg-c" style="background:linear-gradient(135deg,#9b59b6,#a569bd)"></div>Darbai</div>
    <div class="lg-i"><div class="lg-c" style="background:linear-gradient(135deg,#e74c3c,#ec7063)"></div>Kritinis</div>
    <div class="lg-i"><div class="lg-c" style="background:linear-gradient(135deg,#f39c12,#f7b731)"></div>Dƒómesio</div>
    <div class="lg-i"><div class="lg-c" style="background:linear-gradient(135deg,#1abc9c,#48c9b0)"></div>Atlikta ‚úì</div>
  </div>
  <div class="gw"><div class="gs"><div class="gantt" id="gantt"></div></div></div>
  <div class="notes">
    <h2>‚ö†Ô∏è Klausimai Balstetai</h2>
    <div class="ng">
      <div class="ni"><strong>1. Nematomos durys:</strong> Kada pristatymas ir montavimas? PRIE≈† mikrocementƒÖ!</div>
      <div class="ni"><strong>2. Mikrocementas:</strong> Kada meistras? PO dur≈≥ montavimo!</div>
      <div class="ni"><strong>3. Parketas:</strong> Kada klojƒójai? Koordinuoti auk≈°ƒçius!</div>
    </div>
  </div>
  <div class="notes" style="margin-top:12px">
    <h2 style="color:#667eea">üìã Priklausomybƒós</h2>
    <div class="ng">
      <div class="ni info"><strong>Sienos:</strong> Gipskartonis ‚Üí Glaistymas ‚Üí Durys ‚Üí Mikrocementas ‚Üí Da≈æymas</div>
      <div class="ni info"><strong>Grindys:</strong> Auk≈°ƒçiai ≈æinoti iki 02-09</div>
    </div>
  </div>
</div>
</div>

<!-- EDITOR -->
<div id="editor-view" class="view">
<div class="ed-wrap">
  <div class="toolbar">
    <label style="font-size:12px">Projekto prad≈æia:</label>
    <input type="date" id="startDate" class="dt-in" value="2025-01-26" onchange="chgStart()">
    <button class="btn btn-g" onclick="addTask()">‚ûï U≈æduotis</button>
    <button class="btn btn-p" onclick="addSection()">üìÅ Sekcija</button>
    <button class="btn btn-s" onclick="doExport()">üíæ Eksportuoti</button>
    <button class="btn btn-s" onclick="doImport()">üìÇ Importuoti</button>
  </div>
  <div class="prog" id="ep"></div>
  <div class="tw">
    <table class="ed">
      <thead><tr>
        <th style="width:36px"></th>
        <th style="width:30px">‚úì</th>
        <th style="width:240px">U≈æduotis / Etapai</th>
        <th style="width:85px">Tipas</th>
        <th style="width:105px">Prad≈æia</th>
        <th style="width:50px">Trukmƒó</th>
        <th style="width:90px">Pabaiga</th>
        <th>Pastaba</th>
        <th style="width:50px"></th>
      </tr></thead>
      <tbody id="tb"></tbody>
    </table>
  </div>
</div>
</div>

<!-- MODAL -->
<div class="modal" id="modal">
<div class="modal-c">
  <h3 id="mTitle"></h3>
  <textarea id="mData"></textarea>
  <div class="modal-b">
    <button class="btn btn-s" onclick="closeModal()">U≈ædaryti</button>
    <button class="btn btn-p" id="mBtn" onclick="copyData()">Kopijuoti</button>
  </div>
</div>
</div>

<script>
// ===== DATE HELPERS (timezone-safe) =====
function pD(s){const p=s.split('-');return new Date(+p[0],+p[1]-1,+p[2])}
function fD(d){return`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`}
function aD(d,n){const r=new Date(d);r.setDate(r.getDate()+n);return r}
function dB(a,b){return Math.round((new Date(b.getFullYear(),b.getMonth(),b.getDate())-new Date(a.getFullYear(),a.getMonth(),a.getDate()))/864e5)}
function isWe(d){const w=d.getDay();return w===0||w===6}
function mName(d){return d.toLocaleDateString('lt-LT',{month:'short',year:'numeric'})}
function today(){const n=new Date();return new Date(n.getFullYear(),n.getMonth(),n.getDate())}
function esc(s){const d=document.createElement('div');d.textContent=s;return d.innerHTML}

// ===== DATA =====
let PS=pD('2025-01-26'); // project start

// Task: {name, cat, s (startDay from PS), d (duration days), note, done, stages:[{name,done,s,d}]}
// Section: {type:'section', name, critical?}
let T=[
{type:'section',name:'üì¶ PRISTATYMAI IR SPRENDIMAI'},
{name:'Potinkinƒó santechnika, WC rƒómas, trapas',cat:'delivery',s:0,d:7,note:'',done:false,stages:[]},
{name:'Parketo/plyteli≈≥ auk≈°ƒçiai - ≈æinoti',cat:'decision',s:7,d:7,note:'Kritinis terminas!',done:false,stages:[]},
{name:'≈†viestuv≈≥ laid≈≥ i≈°siki≈°imas',cat:'decision',s:7,d:7,note:'',done:false,stages:[]},
{name:'Signalizacija',cat:'delivery',s:7,d:80,note:'',done:false,stages:[
  {name:'1. Kabeli≈≥ instaliacija',done:false,s:7,d:7},
  {name:'2. Davikli≈≥/centralƒós montavimas (po da≈æymo)',done:false,s:62,d:5}
]},
{name:'Plyteli≈≥ pristatymas',cat:'delivery',s:14,d:14,note:'3-4 sav',done:false,stages:[]},
{name:'Spalv≈≥ pasirinkimas (da≈æai)',cat:'decision',s:42,d:7,note:'7 sav',done:false,stages:[]},
{name:'Rozetƒós, jungikliai, ≈°viestuvai, santechnika',cat:'delivery',s:56,d:7,note:'9 sav',done:false,stages:[]},
{name:'Difuzoriai (Ventman) - pristatyti',cat:'delivery',s:14,d:7,note:'Prie≈° gipskartonƒØ',done:false,stages:[]},

{type:'section',name:'‚ö†Ô∏è KRITINIAI - I≈†SIAI≈†KINTI SU BALSTETA',critical:true},
{name:'Nematomos durys (1vnt vonia‚Üîpagalbinƒó)',cat:'critical',s:28,d:14,note:'‚ùì PRIE≈† mikrocementƒÖ!',done:false,stages:[]},
{name:'Mikrocementas (sienos + stakta)',cat:'critical',s:42,d:10,note:'‚ùì PO dur≈≥ montavimo!',done:false,stages:[]},
{name:'Parketo klojimas',cat:'warning',s:56,d:10,note:'‚ùì Klausti Balstetos kada',done:false,stages:[]},

{type:'section',name:'‚è∞ U≈ΩSAKYTI LAIKU (nepamesti!)'},
{name:'Spintos - susirasti gamintojƒÖ',cat:'warning',s:14,d:14,note:'Ie≈°koti DABAR',done:false,stages:[]},
{name:'Spintos - galutinis matavimas',cat:'decision',s:42,d:3,note:'Kai sienos baigtos',done:false,stages:[]},
{name:'Vonios baldas - i≈°sirinkti ir u≈æsakyti',cat:'warning',s:21,d:21,note:'Reikia prie≈° kriauklƒô!',done:false,stages:[]},
{name:'Veidrod≈æiai - i≈°sirinkti',cat:'decision',s:49,d:14,note:'Laidas jau i≈°vestas',done:false,stages:[]},

{type:'section',name:'üî® DARBAI - PARUO≈†IMAS'},
{name:'Griovimo darbai',cat:'work',s:0,d:7,note:'',done:false,stages:[]},
{name:'Elektros instaliacija',cat:'work',s:7,d:70,note:'',done:false,stages:[
  {name:'1. Potinkinƒó (kabeliai, dƒó≈æutƒós)',done:false,s:7,d:14},
  {name:'2. Apdaila (rozetƒós, jungikliai, ≈°viestuvai)',done:false,s:72,d:5}
]},
{name:'Santechnikos instaliacija',cat:'work',s:7,d:70,note:'',done:false,stages:[
  {name:'1. Potinkinƒó (vamzd≈æiai, trapas, WC rƒómas)',done:false,s:7,d:14},
  {name:'2. Apdaila (kriauklƒó, WC, du≈°as, mai≈°ytuvai)',done:false,s:72,d:5}
]},
{name:'Ventiliacijos montavimas',cat:'work',s:14,d:10,note:'Vallox 099 + difuzoriai',done:false,stages:[]},
{name:'Gipskartonio darbai',cat:'work',s:21,d:14,note:'',done:false,stages:[]},
{name:'Grind≈≥ ≈°ildymo instaliacija',cat:'work',s:28,d:10,note:'',done:false,stages:[]},

{type:'section',name:'üî® DARBAI - APDAILA'},
{name:'Glaistymas',cat:'work',s:35,d:10,note:'',done:false,stages:[]},
{name:'Da≈æymas',cat:'work',s:52,d:10,note:'Po mikrocemento',done:false,stages:[]},
{name:'Plytelƒós - vonia',cat:'work',s:56,d:7,note:'',done:false,stages:[]},
{name:'Plytelƒós - pagalbinƒó patalpa',cat:'work',s:63,d:4,note:'',done:false,stages:[]},
{name:'Plytelƒós - virtuvƒó/prie≈°kambaris',cat:'work',s:67,d:5,note:'',done:false,stages:[]},

{type:'section',name:'üî® DARBAI - MONTAVIMAS'},
{name:'Paprastos durys - montavimas',cat:'work',s:70,d:3,note:'Po da≈æymo, prie≈° grindjuostes',done:false,stages:[]},
{name:'Vonios baldas - montavimas',cat:'work',s:70,d:2,note:'',done:false,stages:[]},
{name:'Spintos - montavimas',cat:'work',s:77,d:5,note:'~4-6 sav po matavimo',done:false,stages:[]},
{name:'Veidrod≈æiai - montavimas',cat:'work',s:77,d:2,note:'',done:false,stages:[]},
{name:'Grindjuostƒós',cat:'work',s:82,d:3,note:'Po spint≈≥!',done:false,stages:[]},
{name:'Skalbimo ma≈°inos prijungimas',cat:'work',s:77,d:1,note:'Pagalbinƒó patalpa',done:false,stages:[]},
{name:'Baigiamieji darbai, valymas',cat:'work',s:85,d:7,note:'',done:false,stages:[]},

{type:'section',name:'‚úÖ JAU U≈ΩSAKYTA / NUPIRKTA'},
{name:'Vallox 099 entalpinis rekuperatorius',cat:'done',s:0,d:1,note:'',done:true,stages:[]},
{name:'Difuzoriai (Ventman)',cat:'done',s:0,d:1,note:'',done:true,stages:[]},
{name:'Alice Ceramica vonios keramika',cat:'done',s:0,d:1,note:'',done:true,stages:[]},
{name:'Hansgrohe mai≈°ytuvai',cat:'done',s:0,d:1,note:'',done:true,stages:[]},

{type:'section',name:'‚è∏Ô∏è 2 ETAPAS (vƒóliau)'},
{name:'Virtuvƒós baldai - matavimas',cat:'decision',s:92,d:1,note:'Kai bus pinig≈≥',done:false,stages:[]},
{name:'Virtuvƒós baldai - gamyba',cat:'delivery',s:93,d:30,note:'~4-6 sav',done:false,stages:[]},
{name:'Virtuvƒós baldai - montavimas',cat:'work',s:123,d:3,note:'',done:false,stages:[]},
{name:'Buitinƒó technika',cat:'delivery',s:123,d:3,note:'Orkaitƒó, kaitlentƒó, indaplovƒó',done:false,stages:[]},
];

const cats={delivery:{n:'Pristatymas'},decision:{n:'Sprendimas'},work:{n:'Darbai'},critical:{n:'Kritinis'},warning:{n:'Dƒómesio'},done:{n:'Atlikta'}};

// ===== HELPERS =====
function isDone(t){if(t.type)return false;if(t.stages&&t.stages.length)return t.stages.every(s=>s.done);return t.done}
function stgProg(t){if(!t.stages||!t.stages.length)return null;const d=t.stages.filter(s=>s.done).length;return{d,t:t.stages.length,p:Math.round(d/t.stages.length*100)}}
function syncDone(t){if(t.stages&&t.stages.length)t.done=t.stages.every(s=>s.done)}
function getProgress(){const r=T.filter(t=>!t.type);const n=r.length;const c=r.filter(isDone).length;return{n,c,p:n?Math.round(c/n*100):0}}
function renderProg(id){const{n,c,p}=getProgress();document.getElementById(id).innerHTML=
  `<span class="prog-pct">${p}%</span><div class="prog-bar"><div class="prog-fill" style="width:${p}%"></div></div><span class="prog-txt">${c} i≈° ${n} atlikta</span>`}

// ===== TAB =====
function switchTab(t){
  document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
  document.querySelectorAll('.view').forEach(x=>x.classList.remove('active'));
  document.querySelector(`.tab[onclick="switchTab('${t}')"]`).classList.add('active');
  document.getElementById(t+'-view').classList.add('active');
  if(t==='gantt')renderGantt();
}

// ===== EDITOR =====
function renderEditor(){
  const tb=document.getElementById('tb');tb.innerHTML='';
  T.forEach((t,i)=>{
    const tr=document.createElement('tr');
    tr.draggable=true;tr.dataset.i=i;
    tr.addEventListener('dragstart',e=>{tr.classList.add('drag');e.dataTransfer.setData('text/plain',i)});
    tr.addEventListener('dragend',()=>{tr.classList.remove('drag');document.querySelectorAll('.dov').forEach(x=>x.classList.remove('dov'))});
    tr.addEventListener('dragover',e=>{e.preventDefault();tr.classList.add('dov')});
    tr.addEventListener('dragleave',()=>tr.classList.remove('dov'));
    tr.addEventListener('drop',e=>{e.preventDefault();tr.classList.remove('dov');
      const f=+e.dataTransfer.getData('text/plain');if(f!==i){const x=T.splice(f,1)[0];T.splice(i,0,x);renderEditor()}});

    if(t.type==='section'){
      tr.className='sec';
      tr.innerHTML=`<td class="dh">‚ò∞</td><td></td>
        <td colspan="5"><input type="text" value="${esc(t.name)}" onchange="T[${i}].name=this.value"></td>
        <td></td><td><button class="btn btn-d btn-sm" onclick="del(${i})">üóëÔ∏è</button></td>`;
    } else {
      const sd=aD(PS,t.s), ed=aD(PS,t.s+t.d);
      const dn=isDone(t), hs=t.stages&&t.stages.length>0, sp=stgProg(t);
      if(dn)tr.classList.add('cpl');

      // Stages HTML
      let sh='';
      if(hs||true){
        sh='<div class="stg-wrap">';
        if(hs){
          t.stages.forEach((st,si)=>{
            const ssd=aD(PS,st.s), sed=aD(PS,st.s+st.d);
            const sc=st.done?' done':'';
            sh+=`<div class="stg${sc}">
              <input type="checkbox" ${st.done?'checked':''} onchange="tgStg(${i},${si},this.checked)">
              <div class="sn"><input type="text" value="${esc(st.name)}" onchange="T[${i}].stages[${si}].name=this.value"></div>
              <input type="date" class="sd-in" value="${fD(ssd)}" onchange="chgStgStart(${i},${si},this.value)">
              <input type="number" class="sd-dur" value="${st.d}" min="1" onchange="chgStgDur(${i},${si},+this.value)">
              <span class="sx" onclick="delStg(${i},${si})">‚úï</span>
            </div>`;
          });
          sh+=`<div class="stg-prog"><div class="stg-pb"><div class="stg-pf" style="width:${sp.p}%"></div></div>${sp.d}/${sp.t}</div>`;
        }
        sh+=`<span class="add-stg" onclick="addStg(${i})">+ etapas</span></div>`;
      }

      tr.innerHTML=`<td class="dh">‚ò∞</td>
        <td class="chk-c">${hs
          ?`<span style="font-size:14px;color:${dn?'#1abc9c':'#555'}">${dn?'‚úÖ':'‚è≥'}</span>`
          :`<input type="checkbox" class="chk" ${dn?'checked':''} onchange="tgDone(${i},this.checked)">`}</td>
        <td><input type="text" class="tn" value="${esc(t.name)}" onchange="T[${i}].name=this.value">${sh}</td>
        <td><select onchange="T[${i}].cat=this.value;renderEditor()">
          ${Object.entries(cats).map(([k,v])=>`<option value="${k}" ${t.cat===k?'selected':''}>${v.n}</option>`).join('')}</select></td>
        <td><input type="date" value="${fD(sd)}" onchange="chgS(${i},this.value)"></td>
        <td><input type="number" value="${t.d}" min="1" class="nar" onchange="T[${i}].d=Math.max(1,+this.value);renderEditor()"></td>
        <td class="dur-ro">${fD(ed)}</td>
        <td><input type="text" value="${esc(t.note||'')}" onchange="T[${i}].note=this.value" placeholder="Pastaba..."></td>
        <td><button class="btn btn-d btn-sm" onclick="del(${i})">üóëÔ∏è</button></td>`;
    }
    tb.appendChild(tr);
  });
  renderProg('ep');
}

// Change start date: DURATION stays, end moves
function chgS(i,v){
  T[i].s=dB(PS,pD(v)); renderEditor();
}

// Stage operations
function addStg(i){
  if(!T[i].stages)T[i].stages=[];
  const n=T[i].stages.length+1;
  T[i].stages.push({name:`${n}. Naujas etapas`,done:false,s:T[i].s,d:7});
  syncDone(T[i]);renderEditor();
}
function chgStgStart(i,si,v){T[i].stages[si].s=dB(PS,pD(v));renderEditor()}
function chgStgDur(i,si,v){T[i].stages[si].d=Math.max(1,v);renderEditor()}
function tgStg(i,si,c){T[i].stages[si].done=c;syncDone(T[i]);renderEditor()}
function delStg(i,si){T[i].stages.splice(si,1);syncDone(T[i]);renderEditor()}

// Other
function tgDone(i,c){T[i].done=c;renderEditor()}
function del(i){if(confirm('I≈°trinti?')){T.splice(i,1);renderEditor()}}
function addTask(){T.push({name:'Nauja u≈æduotis',cat:'work',s:0,d:7,note:'',done:false,stages:[]});renderEditor()}
function addSection(){T.push({type:'section',name:'üìÅ Nauja sekcija'});renderEditor()}
function chgStart(){PS=pD(document.getElementById('startDate').value);renderEditor()}

// ===== GANTT =====
function renderGantt(){
  const g=document.getElementById('gantt');const TD=140;const tod=today();let h='';

  // Months
  h+='<div class="mr"><div class="mc tc">U≈æduotis</div>';
  let ms=[],cm=null,cn=0;
  for(let i=0;i<TD;i++){const mn=mName(aD(PS,i));if(mn!==cm){if(cm)ms.push({n:cm,s:cn});cm=mn;cn=1}else cn++}
  ms.push({n:cm,s:cn});ms.forEach(m=>h+=`<div class="mc" style="grid-column:span ${m.s}">${m.n}</div>`);
  h+='</div>';

  // Days
  h+='<div class="dr"><div class="dc tc">Prad≈æia ‚Üí Pabaiga</div>';
  for(let i=0;i<TD;i++){const d=aD(PS,i);const w=isWe(d)?' we':'';const t=d.toDateString()===tod.toDateString()?' td':'';
    h+=`<div class="dc${w}${t}">${d.getDate()}</div>`}
  h+='</div>';

  // Tasks
  for(const t of T){
    if(t.type==='section'){h+=`<div class="sh${t.critical?' cr':''}">${t.name}</div>`;continue}
    const sd=aD(PS,t.s),ed=aD(PS,t.s+t.d);
    const ds=`${fD(sd)} ‚Üí ${fD(ed)}`;
    const dn=isDone(t),hs=t.stages&&t.stages.length>0,sp=stgProg(t);

    h+='<div class="tr">';
    h+=`<div class="tn-g ${t.cat}${dn?' cpl':''}">
      <div class="tt">${dn?'‚úì ':''}${t.name}</div>
      <div class="td-g">${ds}</div>
      ${dn?'<div class="badge">‚úÖ Atlikta</div>':''}
      ${hs&&!dn?`<div class="si">‚è≥ ${sp.d}/${sp.t} etap≈≥</div>`:''}
      ${!dn&&!hs&&t.note?`<div class="note">${t.note}</div>`:''}
    </div>`;
    for(let i=0;i<TD;i++){const w=isWe(aD(PS,i))?' we':'';const inR=i>=t.s&&i<t.s+t.d;
      if(inR){let bc=dn?'cpl-bar':t.cat;
        if(t.d===1)bc+=' single';else if(i===t.s)bc+=' start';else if(i===t.s+t.d-1)bc+=' end';else bc+=' middle';
        h+=`<div class="ds"><div class="bar ${bc}"></div></div>`}
      else h+=`<div class="ds${w}"></div>`}
    h+='</div>';

    // Stage sub-rows
    if(hs){t.stages.forEach(st=>{
      const sd2=st.done;
      h+='<div class="tr">';
      h+=`<div class="tn-g is-stg ${t.cat}${sd2?' cpl':''}">
        <div class="tt">${sd2?'‚úì ':'‚óã '}${st.name}</div>
        <div class="td-g">${fD(aD(PS,st.s))} ‚Üí ${fD(aD(PS,st.s+st.d))} (${st.d}d)</div>
      </div>`;
      for(let i=0;i<TD;i++){const w=isWe(aD(PS,i))?' we':'';const inR=i>=st.s&&i<st.s+st.d;
        if(inR){let bc=sd2?'cpl-bar stg-bar':t.cat+' stg-bar';
          const len=st.d;if(len===1)bc+=' single';else if(i===st.s)bc+=' start';else if(i===st.s+st.d-1)bc+=' end';else bc+=' middle';
          h+=`<div class="ds is-stg"><div class="bar ${bc}"></div></div>`}
        else h+=`<div class="ds is-stg${w}"></div>`}
      h+='</div>';
    })}
  }
  g.innerHTML=h;

  // Summary
  const real=T.filter(x=>!x.type);
  const mx=Math.max(...real.map(x=>x.s+x.d));
  const eDate=aD(PS,mx);
  const cr=real.filter(x=>!isDone(x)&&(x.cat==='critical'||x.cat==='warning')).length;
  const{c}=getProgress();
  document.getElementById('summary').innerHTML=`
    <div class="sc"><div class="n">${fD(PS).slice(5)}</div><div class="l">Prad≈æia</div></div>
    <div class="sc"><div class="n">${mx}d</div><div class="l">Trukmƒó</div></div>
    <div class="sc"><div class="n">${fD(eDate).slice(5)}</div><div class="l">Pabaiga</div></div>
    <div class="sc cr"><div class="n">${cr}</div><div class="l">Kritiniai</div></div>
    <div class="sc ok"><div class="n">${c}</div><div class="l">Atlikta ‚úì</div></div>`;
  renderProg('gp');
}

// ===== EXPORT/IMPORT =====
function doExport(){
  document.getElementById('mTitle').textContent='Eksportuoti duomenis';
  document.getElementById('mData').value=JSON.stringify({projectStart:fD(PS),tasks:T},null,2);
  document.getElementById('mBtn').textContent='Kopijuoti';
  document.getElementById('mBtn').onclick=copyData;
  document.getElementById('modal').classList.add('active');
}
function doImport(){
  document.getElementById('mTitle').textContent='Importuoti duomenis';
  document.getElementById('mData').value='';
  document.getElementById('mBtn').textContent='Importuoti';
  document.getElementById('mBtn').onclick=impData;
  document.getElementById('modal').classList.add('active');
}
function copyData(){
  const ta=document.getElementById('mData');ta.select();
  navigator.clipboard.writeText(ta.value).then(()=>alert('Nukopijuota!')).catch(()=>{document.execCommand('copy');alert('Nukopijuota!')});
}
function impData(){
  try{
    const d=JSON.parse(document.getElementById('mData').value);
    if(d.projectStart){PS=pD(d.projectStart);document.getElementById('startDate').value=d.projectStart}
    if(d.tasks){T=d.tasks.map(t=>{if(!t.type){if(t.done===undefined)t.done=false;if(!t.stages)t.stages=[];
      t.stages.forEach(st=>{if(st.s===undefined)st.s=t.s;if(st.d===undefined)st.d=7;if(st.done===undefined)st.done=false})}return t})}
    renderEditor();closeModal();alert('Importuota!');
  }catch(e){alert('Klaida: neteisingas formatas')}
}
function closeModal(){document.getElementById('modal').classList.remove('active')}

// ===== INIT =====
renderEditor();renderGantt();
</script>
</body>
</html>
